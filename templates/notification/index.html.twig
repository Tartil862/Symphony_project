{% extends 'base.html.twig' %}

{% block title %}Notifications{% endblock %}
{% block page_title %}Notifications{% endblock %}

{% block stylesheets %}
<style>
    .notif-page-item {
        display: flex;
        gap: 1rem;
        padding: 1.1rem 1.4rem;
        border-bottom: 1px solid #f1f5f9;
        transition: all .3s ease;
        align-items: flex-start;
    }
    .notif-page-item:last-child { border-bottom: none; }
    .notif-page-item:hover { background: #FAF6F1; }
    .notif-page-item.unread {
        background: linear-gradient(135deg, rgba(145,184,147,.04), rgba(229,198,164,.04));
        border-left: 3px solid #91B893;
    }
    .notif-page-icon {
        width: 44px; height: 44px;
        border-radius: .7rem;
        display: grid; place-items: center;
        color: #fff; font-size: 1.05rem;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(0,0,0,.1);
    }
    .notif-page-content { flex: 1; min-width: 0; }
    .notif-page-msg {
        font-size: .88rem;
        font-weight: 500;
        color: #334155;
        line-height: 1.45;
    }
    .notif-page-item.unread .notif-page-msg {
        font-weight: 650;
        color: #1e293b;
    }
    .notif-page-meta {
        display: flex; gap: .8rem; align-items: center;
        margin-top: .35rem;
        font-size: .72rem; color: #94a3b8;
    }
    .notif-type-badge {
        font-size: .62rem;
        font-weight: 700;
        padding: .15rem .5rem;
        border-radius: 999px;
        color: #fff;
        text-transform: uppercase;
        letter-spacing: .04em;
    }
    .notif-actions {
        display: flex; gap: .3rem; flex-shrink: 0; align-self: center;
    }
    .notif-actions .btn { padding: .3rem .5rem; font-size: .78rem; }

    .notif-header-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: .75rem;
        margin-bottom: 1.2rem;
    }
    .notif-stats {
        display: flex; gap: 1rem;
    }
    .notif-stat {
        background: linear-gradient(135deg, #f5f0ea, #efe8df);
        padding: .5rem 1rem;
        border-radius: .6rem;
        font-size: .78rem;
        font-weight: 600;
        color: #2A3638;
        display: flex; align-items: center; gap: .4rem;
    }
    .notif-stat .count {
        background: linear-gradient(135deg, #2A3638, #4a6264);
        color: #fff;
        font-size: .68rem;
        padding: .1rem .45rem;
        border-radius: 999px;
        font-weight: 700;
    }

    @keyframes notifIn {
        from { opacity: 0; transform: translateX(-10px); }
        to { opacity: 1; transform: translateX(0); }
    }
    .notif-page-item {
        animation: notifIn .4s cubic-bezier(.4,0,.2,1) both;
    }
    .notif-page-item:nth-child(1) { animation-delay: .03s; }
    .notif-page-item:nth-child(2) { animation-delay: .06s; }
    .notif-page-item:nth-child(3) { animation-delay: .09s; }
    .notif-page-item:nth-child(4) { animation-delay: .12s; }
    .notif-page-item:nth-child(5) { animation-delay: .15s; }
    .notif-page-item:nth-child(6) { animation-delay: .18s; }
    .notif-page-item:nth-child(7) { animation-delay: .21s; }
    .notif-page-item:nth-child(8) { animation-delay: .24s; }
</style>
{% endblock %}

{% block body %}
    {# ── Header ── #}
    <div class="notif-header-bar">
        <div>
            <p class="text-muted mb-0" style="font-size:.85rem">{{ 'notification.stay_informed'|trans }}</p>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            <div class="notif-stats">
                <div class="notif-stat">
                    <i class="bi bi-bell"></i> {{ 'notification.total'|trans }}
                    <span class="count">{{ notifications|length }}</span>
                </div>
                <div class="notif-stat">
                    <i class="bi bi-envelope"></i> {{ 'notification.unread_count'|trans }}
                    <span class="count">{{ notif_unread_count }}</span>
                </div>
            </div>
            {% if notif_unread_count > 0 %}
                <a href="{{ path('app_notification_read_all') }}" class="btn btn-accent" style="font-size:.8rem;padding:.45rem 1rem">
                    <i class="bi bi-check-all me-1"></i> {{ 'notification.mark_all_read'|trans }}
                </a>
            {% endif %}
            {% if notifications|length > 0 %}
                <form method="post" action="{{ path('app_notification_delete_all') }}"
                      data-confirm="{{ 'notification.empty_desc'|trans }}"
                      data-confirm-title="{{ 'notification.delete_all'|trans }} ?"
                      data-confirm-icon="bi-trash3"
                      data-confirm-variant="danger"
                      data-confirm-btn="{{ 'notification.delete_all'|trans }}"
                      style="display:inline">
                    <input type="hidden" name="_token" value="{{ csrf_token('delete-all-notif') }}">
                    <button type="submit" class="btn btn-danger-soft" style="font-size:.8rem;padding:.45rem 1rem">
                        <i class="bi bi-trash3 me-1"></i> {{ 'notification.delete_all'|trans }}
                    </button>
                </form>
            {% endif %}
        </div>
    </div>

    {# ── Flash messages ── #}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ label == 'success' ? 'success' : (label == 'danger' ? 'danger' : 'warning') }} alert-dismissible fade show mb-3" role="alert" style="border:none;border-radius:.8rem;font-size:.85rem">
                <i class="bi bi-{{ label == 'success' ? 'check-circle' : 'exclamation-triangle' }} me-1"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" style="font-size:.65rem"></button>
            </div>
        {% endfor %}
    {% endfor %}

    {# ── Notifications list ── #}
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-bell me-2"></i>{{ 'notification.all_notifications'|trans }}</span>
            <span class="badge-count">{{ notifications|length }}</span>
        </div>
        <div class="card-body p-0">
            {% if notifications|length > 0 %}
                {% for notif in notifications %}
                    <div class="notif-page-item {{ not notif.isRead ? 'unread' : '' }}">
                        <div class="notif-page-icon" style="background:{{ notif.typeColor }}">
                            <i class="bi {{ notif.displayIcon }}"></i>
                        </div>
                        <div class="notif-page-content">
                            <div class="notif-page-msg">{{ notif.message }}</div>
                            <div class="notif-page-meta">
                                <span><i class="bi bi-clock me-1"></i>{{ notif.createdAt|date('d/m/Y H:i') }}</span>
                                <span class="notif-type-badge" style="background:{{ notif.typeColor }}">{{ notif.type }}</span>
                                {% if not notif.isRead %}
                                    <span style="color:#91B893;font-weight:600"><i class="bi bi-circle-fill" style="font-size:.35rem;vertical-align:middle"></i> {{ 'notification.not_read'|trans }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="notif-actions">
                            {% if not notif.isRead %}
                                <a href="{{ path('app_notification_read', {id: notif.id}) }}" class="btn btn-ghost" title="{{ 'notification.mark_read'|trans }}">
                                    <i class="bi bi-check2"></i>
                                </a>
                            {% endif %}
                            {% if notif.link %}
                                <a href="{{ path('app_notification_read', {id: notif.id}) }}" class="btn btn-ghost" title="{{ 'common.show'|trans }}">
                                    <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                            {% endif %}
                            <form method="post" action="{{ path('app_notification_delete', {id: notif.id}) }}"
                                  data-confirm="{{ 'notification.empty_desc'|trans }}"
                                  data-confirm-title="{{ 'common.delete'|trans }} ?"
                                  data-confirm-icon="bi-trash3"
                                  data-confirm-variant="danger"
                                  data-confirm-btn="{{ 'common.delete'|trans }}"
                                  style="display:inline">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete-notif-' ~ notif.id) }}">
                                <button type="submit" class="btn btn-ghost" style="color:#E54A5F" title="{{ 'common.delete'|trans }}">
                                    <i class="bi bi-trash3"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-bell-slash" style="font-size:3rem;color:#E5C6A4"></i>
                    <p class="mt-3 text-muted" style="font-size:.9rem">{{ 'notification.empty_desc'|trans }}</p>
                    <p class="text-muted" style="font-size:.78rem">{{ 'notification.empty_hint'|trans }}</p>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}
